---
title: "MVP+AppRootController+Routerã‚„ã£ã¦ã¿ãŸ"
emoji: "ğŸ¤”"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [Swift]
published: false
---

## RootControllerã¨ã¯
UIWindowã®rootViewControllerã«ã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦ViewControllerã‚’é…ç½®ã—ï¼Œãã®ViewControllerã®å­ViewControllerã¨ã—ã¦å„ç”»é¢ã‚’æ§‹æˆã™ã‚‹ã¨è‰²ã€…æ¥½ã«ãªã‚‹(ã‚‰ã—ã„)

ãƒªãƒã‚¸ãƒˆãƒªã¯[ã“ã¡ã‚‰](https://github.com/Hyperbolic4183/MVP-RootController-Router)

- [AppRootControllerã®ã”ææ¡ˆ(ç°¡ç•¥èª¬æ˜ç‰ˆ)](https://speakerdeck.com/yimajo/approotcontrollerfalsegoti-an-jian-lue-shuo-ming-ban)
- [AppRootControllerã‚’ä½¿ã£ã¦ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã™ã‚‹](https://speakerdeck.com/yimajo/approotcontroller-woshi-tutesupuratusiyuanimesiyonwoshi-zhuang-suru-2017-dong)
- [RootViewControllerã§ç”»é¢é·ç§»ã‚’ã¾ã¨ã‚ãŸè©±](https://speakerdeck.com/satotakeshi/rootviewcontrollerdehua-mian-qian-yi-womatometahua)
- [iOS:Root Controller Navigation](https://stasost.medium.com/ios-root-controller-navigation-3625eedbbff)
  
ã§è©³ã—ãèª¬æ˜ã•ã‚Œã¦ã„ã‚‹ï¼
ä»Šå›ã¯ï¼ŒRedViewController,BlueViewController,GreenViewControllerã®3ã¤ã®ViewControllerã‚’ç”¨æ„ã—ï¼Œå„ViewControllerã‹ã‚‰é·ç§»ã™ã‚‹ã“ã¨ã‚’ç›®æ¨™ã«ã—ãŸï¼
![](https://storage.googleapis.com/zenn-user-upload/4f9ed0d23738-20220226.jpg)

VCé–“ã®ç§»å‹•ã¯RootViewControllerã®currentãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å·®ã—æ›¿ãˆï¼ŒRootViewControllerã®å­ViewControllerã«ã™ã‚‹ã“ã¨ã§è¡Œã£ã¦ã„ã‚‹ï¼

## Routerã¨ã¯
[iOSã‚¢ãƒ—ãƒªè¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³å…¥é–€](https://peaks.cc/books/iOS_architecture)ã«ã‚ˆã‚‹ã¨ï¼ŒRouterã®å½¹å‰²ã¯ï¼Œ**é·ç§»å…ˆã®ç”»é¢ã‚’ç”Ÿæˆã—ï¼Œé·ç§»å‡¦ç†ã®è²¬å‹™ã‚’æ‹…ã†ã“ã¨**ã§ã‚ã‚‹ï¼ã“ã“ã§ã¯ï¼Œå„ViewControllerãŒRouterã‚’æŒã¤ã®ã§ã¯ãªãï¼Œã‚ã‚‹ViewControllerã®é·ç§»ã«é–¢ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã«åˆ‡ã‚Šå‡ºã—ï¼Œå…±é€šã®Routerã‚¯ãƒ©ã‚¹ã§ãã‚Œã«æº–æ‹ ã•ã›ã‚‹ã¨ã„ã†å®Ÿè£…ã«ã—ãŸï¼

## é€šçŸ¥ã®æµã‚Œ
MVPã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’ä½¿ã„ï¼ŒViewãŒã†ã‘ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’Presenterã«é€šçŸ¥ã—ï¼ŒPresenterã‹ã‚‰Routerã«é€šçŸ¥ã™ã‚‹ã¨ã„ã†æµã‚Œã«ã—ãŸï¼
![](https://storage.googleapis.com/zenn-user-upload/52a23b1690a1-20220226.jpg)


ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ï¼
â†“
ãƒœã‚¿ãƒ³ã«`addTarget`ã—ãŸé–¢æ•°ãŒå®Ÿè¡Œã•ã‚Œã‚‹

```Swift
@objc func didTapTransitionToBlueButton() {
    guard let presenter = presenter as? RedPresenterProtocol else { fatalError() }
    presenter.didTransitionButtonTapped(to: .blue)
}
```
â†“
presenterã®ãƒ¡ã‚½ãƒƒãƒ‰ãŒå‘¼ã°ã‚Œã‚‹
```Swift
func didTransitionButtonTapped(to color: RedViewController.NextRoute) {
    router.transition(to: color)
}
```
â†“
Routerã®ãƒ¡ã‚½ãƒƒãƒ‰ãŒå‘¼ã°ã‚Œã‚‹
```Swift
func transition(to color: RedViewController.NextRoute) {
    switch color {
    case .red:
        transitionToRed()
    case .blue:
        transitionToBlue()
    case .green:
        transitionToGreen()
    }
}
```

## å…·ä½“çš„ãªå®Ÿè£…

### PresenterInjectableãƒ—ãƒ­ãƒˆã‚³ãƒ«

å„ViewControllerã¯Presenterã‚’æŒã¤ï¼å¾Œè¿°ã™ã‚‹Routerã®ä¸­ã§ViewControllerã‚’å·®ã—æ›¿ãˆã‚‹ãŸã‚ã®æŠ½è±¡çš„ãªé–¢æ•°ã‚’ä½œæˆã™ã‚‹ãŸã‚ã«ï¼Œ`PresenterInjectable`ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’å®šç¾©ã—ï¼Œå„ViewControllerã«æº–æ‹ ã•ã›ã‚‹ï¼

```Swift
protocol PresenterInjectable: UIViewController {
    var presenter: ColorPresenter? { get }
    func inject(presenter: ColorPresenter)
}
```

### ViewController

ãƒœã‚¿ãƒ³ã‚’å®šç¾©ã—ã¦é…ç½®ã—ãŸã‚Šï¼Œãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã¨ãã®é€šçŸ¥ã®è¨­å®šã‚’è¡Œã£ã¦ã„ã‚‹ï¼

```Swift
class RedViewController: UIViewController, PresenterInjectable {
    
    var presenter: ColorPresenter?
    
    func inject(presenter: ColorPresenter) {
        self.presenter = presenter
    }
    
    enum NextRoute {
        case red
        case blue
        case green
    }

    let transitionToRedButton: UIButton = {
        let button = UIButton(type: .system)
        button.setTitle("toRed", for: .normal)
        button.addTarget(self, action: #selector(didTapTransitionToRedButton), for: .touchUpInside)
        return button
    }()
    
    let transitionToBlueButton: UIButton = {
        let button = UIButton(type: .system)
        button.setTitle("toBlue", for: .normal)
        button.addTarget(self, action: #selector(didTapTransitionToBlueButton), for: .touchUpInside)
        return button
    }()
    
    let transitionToGreenButton: UIButton = {
        let button = UIButton(type: .system)
        button.setTitle("toGreen", for: .normal)
        button.addTarget(self, action: #selector(didTapTransitionToGreenButton), for: .touchUpInside)
        return button
    }()

    override func viewDidLoad() {
        super.viewDidLoad()
        view.backgroundColor = .red
        setup()
    }

    private func setup() {
        setupTransitionToRedBuuton()
        setupTransitionToBlueButton()
        setupTransitionToGreenButton()
    }
    
    private func setupTransitionToRedBuuton() {
        view.addSubview(transitionToRedButton)
        transitionToRedButton.translatesAutoresizingMaskIntoConstraints = false
        NSLayoutConstraint.activate([
            transitionToRedButton.centerXAnchor.constraint(equalTo: view.centerXAnchor),
            transitionToRedButton.centerYAnchor.constraint(equalTo: view.centerYAnchor)
        ])
    }
    
    private func setupTransitionToBlueButton() {
        view.addSubview(transitionToBlueButton)
        transitionToBlueButton.translatesAutoresizingMaskIntoConstraints = false
        NSLayoutConstraint.activate([
            transitionToBlueButton.leadingAnchor.constraint(equalTo: view.leadingAnchor),
            transitionToBlueButton.centerYAnchor.constraint(equalTo: view.centerYAnchor)
        ])
    }
    
    private func setupTransitionToGreenButton() {
        view.addSubview(transitionToGreenButton)
        transitionToGreenButton.translatesAutoresizingMaskIntoConstraints = false
        NSLayoutConstraint.activate([
            transitionToGreenButton.trailingAnchor.constraint(equalTo: view.trailingAnchor),
            transitionToGreenButton.centerYAnchor.constraint(equalTo: view.centerYAnchor)
        ])
    }
    
    @objc func didTapTransitionToRedButton() {
        guard let presenter = presenter as? RedPresenterProtocol else { fatalError()
        }
        presenter.didTransitionButtonTapped(to: .red)
    }
    
    @objc func didTapTransitionToBlueButton() {
        guard let presenter = presenter as? RedPresenterProtocol else { fatalError() }
        presenter.didTransitionButtonTapped(to: .blue)
    }
    
    @objc func didTapTransitionToGreenButton() {
        guard let presenter = presenter as? RedPresenterProtocol else { fatalError() }
        presenter.didTransitionButtonTapped(to: .green)
    }
}
```

### ColorPresenterãƒ—ãƒ­ãƒˆã‚³ãƒ«
å…ˆã»ã©è§¦ã‚ŒãŸViewControllerã‚’å·®ã—æ›¿ãˆã‚‹ãŸã‚ã®æŠ½è±¡çš„ãªé–¢æ•°ã®ä½œæˆã«ã¯ï¼ŒViewControllerã®æŠ½è±¡åŒ–ã ã‘ã§ãªãPresenterã®æŠ½è±¡åŒ–ã‚’å¿…è¦ã¨ãªã‚‹ï¼`ColorPresenter`ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’å®šç¾©ã—ï¼Œå„Presenterã«æº–æ‹ ã•ã›ã‚‹ï¼

```Swift
protocol ColorPresenter {}
```

```Swift
protocol RedPresenterProtocol: ColorPresenter {
    func didTransitionButtonTapped(to color: RedViewController.NextRoute)
}
protocol BluePresenterProtocol: ColorPresenter {
    func didTransitionButtonTapped(to color: BlueViewController.NextRoute)
}
```
`didTransitionButtonTapped()`ã‚’`ColorPresenter`ã§å®šç¾©ã—ã‚ˆã†ã‹è¿·ã£ãŸãŒï¼Œãã®ãŸã‚ã«ã¯å¼•æ•°ã®ViewControllerã‚’æŠ½è±¡åŒ–ã™ã‚‹å¿…è¦ãŒã‚ã‚Šï¼Œãã®æŠ½è±¡åŒ–ã«ã¯ã‚ã¾ã‚Šæ„å‘³ãŒãªã„(ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã ã‹ã‚‰ã§ãã‚‹æŠ½è±¡åŒ–ã ã¨æ„Ÿã˜ãŸ)ã¨æ€ã£ãŸã®ã§ã‚„ã‚ãŸï¼

### Presenterã‚¯ãƒ©ã‚¹

Viewã‚¯ãƒ©ã‚¹ã‚’å¼±å‚ç…§ã§æŒãŸã›ãŸï¼
```Swift

final class RedPresenter {
    
    private(set) weak var view: PresenterInjectable!
    private let router: RedRouterProtocol
    
    init(view: PresenterInjectable) {
        print("RedPresenter is initialized")
        self.view = view
        self.router = AppDelegate.shared.router
    }
}

extension RedPresenter: RedPresenterProtocol {
    func didTransitionButtonTapped(to color: RedViewController.NextRoute) {
        router.transition(to: color)
    }
}
```

### Routerã‚¯ãƒ©ã‚¹

å¤ã„ViewControllerã‚’removeã—ï¼Œæ–°ã—ã„ViewControllerã‚’ç”Ÿæˆã—Presenterã‚’è¨­å®šã—ï¼ŒaddChildã™ã‚‹ã®ã¯`replace(with viewController: PresenterInjectable, presenter: ColorPresenter)`ãŒè¡Œã£ã¦ã„ã‚‹ï¼ã“ã®é–¢æ•°ã‚’ä½œã‚‹ãŸã‚ã«`PresenterInjectable`ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã¨`ColorPresenter`ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã‚’å®šç¾©ã—ãŸï¼

```Swift
class Router {
    
    func transitionToBlue() {
        let blueViewController = BlueViewController()
        let bluePresenter = BluePresenter(view: blueViewController)
        replace(with: blueViewController, presenter: bluePresenter)
    }
    
    func transitionToRed() {
        let redViewController = RedViewController()
        let redPresenter = RedPresenter(view: redViewController)
        replace(with: redViewController, presenter: redPresenter)
    }
    
    func transitionToGreen() {
        let greenViewController = GreenViewController()
        let greenPresenter = GreenPresenter(view: greenViewController)
        replace(with: greenViewController, presenter: greenPresenter)
    }
    
    func replace(with viewController: PresenterInjectable, presenter: ColorPresenter) {
        let rootViewController = AppDelegate.shared.rootViewController
        viewController.inject(presenter: presenter)
    
        rootViewController.current.willMove(toParent: nil)
        rootViewController.current.removeFromParent()
        rootViewController.current.view.removeFromSuperview()
        rootViewController.current = viewController
        
        rootViewController.addChild(rootViewController.current)
        rootViewController.current.view.frame = rootViewController.view.bounds
        rootViewController.view.addSubview(rootViewController.current.view)
        rootViewController.current.didMove(toParent: rootViewController)
    }
}
```

å„RouterProtocolã«æº–æ‹ ã•ã›ã¦ã„ã‚‹ï¼ViewControllerãŒåˆ—æŒ™å‹`NextRoute`ã‚’æŒãŸã›ã‚‹ã“ã¨ã§ï¼Œ3ã¤ã®é·ç§»å…ˆã«å¯¾ã—ã¦ä¸€ã¤ã®Routerãƒ¡ã‚½ãƒƒãƒ‰ã§æ¸ˆã‚“ã§ã„ã‚‹ï¼

```Swift
extension Router: RedRouterProtocol {
    func transition(to color: RedViewController.NextRoute) {
        switch color {
        case .red:
            transitionToRed()
        case .blue:
            transitionToBlue()
        case .green:
            transitionToGreen()
        }
    }
}

```


